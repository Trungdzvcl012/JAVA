<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lịch Hẹn Của Tôi - Nha Khoa Sunshine</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <style th:replace="~{fragments/css :: style}"></style>
</head>
<body>
    <nav th:replace="~{fragments/header-logged-in :: header}"></nav>

    <!-- Alert thông báo -->
    <div th:if="${param.success} or ${param.error}" class="container mt-3">
        <div th:if="${param.success}" class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle me-2"></i>
            <span th:if="${param.success == 'true'}">Thanh toán / Đặt lịch thành công!</span>
            <span th:if="${param.success == 'huy'}">Hủy lịch hẹn thành công!</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        <div th:if="${param.error}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-circle me-2"></i>
            <span th:if="${param.error == 'huy'}">Không thể hủy lịch hẹn!</span>
            <span th:if="${param.error == 'notfound'}">Không tìm thấy lịch hẹn!</span>
            <span th:if="${param.error == 'permission'}">Bạn không có quyền truy cập!</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    </div>

    <section class="py-5" style="min-height: 80vh;">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="fw-bold">Lịch Hẹn Của Tôi</h2>
                <a th:href="@{/lich-hen/dat-lich}" class="btn btn-primary">
                    <i class="fas fa-plus me-2"></i>Đặt Lịch Mới
                </a>
            </div>

            <!-- Thống kê nhanh -->
            <div class="row mb-4" th:if="${tongLichHen > 0}">
                <div class="col-md-3 mb-3">
                    <div class="card stats-card">
                        <div class="card-body text-center py-4">
                            <h3 class="mb-0" th:text="${tongLichHen}">0</h3>
                            <small>Tổng Lịch Hẹn</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card bg-warning text-dark">
                        <div class="card-body text-center py-4">
                            <h3 class="mb-0" th:text="${lichHenChoXacNhan}">0</h3>
                            <small>Chờ Xác Nhận</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card bg-info text-white">
                        <div class="card-body text-center py-4">
                            <h3 class="mb-0" th:text="${lichHenDaXacNhan}">0</h3>
                            <small>Đã Thanh Toán / Xác Nhận</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card bg-success text-white">
                        <div class="card-body text-center py-4">
                            <h3 class="mb-0" th:text="${lichHenHoanThanh}">0</h3>
                            <small>Hoàn Thành</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabs danh sách lịch -->
            <ul class="nav nav-tabs mb-4" id="appointmentTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="all-tab" data-bs-toggle="tab" data-bs-target="#all" type="button">
                        Tất Cả (<span th:text="${tongLichHen}">0</span>)
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="waiting-tab" data-bs-toggle="tab" data-bs-target="#waiting" type="button">
                        Chờ Xác Nhận (<span th:text="${lichHenChoXacNhan}">0</span>)
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="confirmed-tab" data-bs-toggle="tab" data-bs-target="#confirmed" type="button">
                        Đã Xác Nhận (<span th:text="${lichHenDaXacNhan}">0</span>)
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="completed-tab" data-bs-toggle="tab" data-bs-target="#completed" type="button">
                        Hoàn Thành (<span th:text="${lichHenHoanThanh}">0</span>)
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="appointmentTabsContent">

                <!-- Tab Tất cả -->
                <div class="tab-pane fade show active" id="all" role="tabpanel">
                    <div th:if="${not #lists.isEmpty(lichHens)}">
                        <div th:each="lichHen : ${lichHens}" class="card service-card mb-4">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <h5 th:text="${lichHen.dichVu?.tenDichVu} ?: 'Không xác định'">Dịch vụ</h5>
                                            <span th:with="badgeClass=${lichHen.trangThai == 'DA_XAC_NHAN'} ? 'badge-confirmed' : 
                                                          (${lichHen.trangThai == 'CHO_XAC_NHAN'} ? 'badge-waiting' : 
                                                          (${lichHen.trangThai == 'DA_HOAN_THANH'} ? 'badge-completed' : 'badge-cancelled'))"
                                                  th:classappend="'badge-status ' + ${badgeClass}">
                                                <span th:text="${lichHen.trangThaiDisplayName} ?: 'Không xác định'">Trạng thái</span>
                                            </span>
                                        </div>
                                        <p class="mb-1">
                                            <i class="fas fa-user-md text-primary me-2"></i>
                                            <span th:text="${lichHen.bacSi?.hoTen} ?: 'Không xác định'">Bác sĩ</span>
                                        </p>
                                        <p class="mb-1">
                                            <i class="fas fa-clock text-primary me-2"></i>
                                            <span th:text="${#temporals.format(lichHen.thoiGianHen, 'dd/MM/yyyy HH:mm')}">Thời gian</span>
                                        </p>
                                        <p class="mb-0 text-muted" th:if="${lichHen.lyDoKham}">
                                            <i class="fas fa-sticky-note me-2"></i>
                                            <span th:text="${lichHen.lyDoKham}">Lý do khám</span>
                                        </p>
                                    </div>
                                    <div class="col-md-4 text-end">
                                        <div class="btn-group-vertical">
                                            <a th:href="@{/lich-hen/{id}(id=${lichHen.id})}" 
                                               class="btn btn-outline-primary btn-sm mb-2">
                                               <i class="fas fa-eye me-1"></i>Chi Tiết
                                            </a>
                                            <th:block th:if="${lichHen.trangThai == 'CHO_XAC_NHAN' or lichHen.trangThai == 'DA_XAC_NHAN'}">
                                                <form th:action="@{/lich-hen/huy/{id}(id=${lichHen.id})}" method="post" class="d-inline">
                                                    <button type="submit" class="btn btn-outline-danger btn-sm" onclick="return confirm('Bạn có chắc muốn hủy lịch hẹn này?')">
                                                        <i class="fas fa-times me-1"></i>Hủy Lịch
                                                    </button>
                                                </form>
                                            </th:block>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div th:if="${#lists.isEmpty(lichHens)}" class="text-center py-5">
                        <i class="fas fa-calendar-times fa-4x text-muted mb-3"></i>
                        <h4 class="text-muted">Chưa có lịch hẹn nào</h4>
                        <p class="text-muted mb-4">Hãy đặt lịch hẹn đầu tiên của bạn</p>
                        <a th:href="@{/lich-hen/dat-lich}" class="btn btn-primary">
                            <i class="fas fa-plus me-2"></i>Đặt Lịch Ngay
                        </a>
                    </div>
                </div>

                <!-- Tab Chờ xác nhận -->
                <div class="tab-pane fade" id="waiting" role="tabpanel">
                    <div th:each="lichHen : ${lichHens}" th:if="${lichHen.trangThai == 'CHO_XAC_NHAN'}" class="card service-card mb-4">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h5 th:text="${lichHen.dichVu?.tenDichVu} ?: 'Không xác định'">Dịch vụ</h5>
                                        <span class="badge-status badge-waiting">
                                            <span th:text="${lichHen.trangThaiDisplayName}">Chờ Xác Nhận</span>
                                        </span>
                                    </div>
                                    <p class="mb-1">
                                        <i class="fas fa-user-md text-primary me-2"></i>
                                        <span th:text="${lichHen.bacSi?.hoTen} ?: 'Không xác định'">Bác sĩ</span>
                                    </p>
                                    <p class="mb-1">
                                        <i class="fas fa-clock text-primary me-2"></i>
                                        <span th:text="${#temporals.format(lichHen.thoiGianHen, 'dd/MM/yyyy HH:mm')}">Thời gian</span>
                                    </p>
                                    <p class="mb-0 text-muted" th:if="${lichHen.lyDoKham}">
                                        <i class="fas fa-sticky-note me-2"></i>
                                        <span th:text="${lichHen.lyDoKham}">Lý do khám</span>
                                    </p>
                                </div>
                                <div class="col-md-4 text-end">
                                    <div class="btn-group-vertical">
                                        <a th:href="@{/lich-hen/{id}(id=${lichHen.id})}" 
                                           class="btn btn-outline-primary btn-sm mb-2">
                                           <i class="fas fa-eye me-1"></i>Chi Tiết
                                        </a>
                                        <form th:action="@{/lich-hen/huy/{id}(id=${lichHen.id})}" method="post" class="d-inline">
                                            <button type="submit" class="btn btn-outline-danger btn-sm" onclick="return confirm('Bạn có chắc muốn hủy lịch hẹn này?')">
                                                <i class="fas fa-times me-1"></i>Hủy Lịch
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div th:if="${lichHenChoXacNhan == 0}" class="text-center py-5">
                        <i class="fas fa-clock fa-4x text-muted mb-3"></i>
                        <h4 class="text-muted">Không có lịch hẹn chờ xác nhận</h4>
                    </div>
                </div>

                <!-- Tab Đã xác nhận -->
                <div class="tab-pane fade" id="confirmed" role="tabpanel">
                    <div th:each="lichHen : ${lichHens}" th:if="${lichHen.trangThai == 'DA_XAC_NHAN'}" class="card service-card mb-4">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h5 th:text="${lichHen.dichVu?.tenDichVu} ?: 'Không xác định'">Dịch vụ</h5>
                                        <span class="badge-status badge-confirmed">
                                            <span th:text="${lichHen.trangThaiDisplayName}">Đã Xác Nhận</span>
                                        </span>
                                    </div>
                                    <p class="mb-1">
                                        <i class="fas fa-user-md text-primary me-2"></i>
                                        <span th:text="${lichHen.bacSi?.hoTen} ?: 'Không xác định'">Bác sĩ</span>
                                    </p>
                                    <p class="mb-1">
                                        <i class="fas fa-clock text-primary me-2"></i>
                                        <span th:text="${#temporals.format(lichHen.thoiGianHen, 'dd/MM/yyyy HH:mm')}">Thời gian</span>
                                    </p>
                                    <p class="mb-0 text-muted" th:if="${lichHen.lyDoKham}">
                                        <i class="fas fa-sticky-note me-2"></i>
                                        <span th:text="${lichHen.lyDoKham}">Lý do khám</span>
                                    </p>
                                </div>
                                <div class="col-md-4 text-end">
                                    <div class="btn-group-vertical">
                                        <a th:href="@{/lich-hen/{id}(id=${lichHen.id})}" 
                                           class="btn btn-outline-primary btn-sm mb-2">
                                           <i class="fas fa-eye me-1"></i>Chi Tiết
                                        </a>
                                        <form th:action="@{/lich-hen/huy/{id}(id=${lichHen.id})}" method="post" class="d-inline">
                                            <button type="submit" class="btn btn-outline-danger btn-sm" onclick="return confirm('Bạn có chắc muốn hủy lịch hẹn này?')">
                                                <i class="fas fa-times me-1"></i>Hủy Lịch
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div th:if="${lichHenDaXacNhan == 0}" class="text-center py-5">
                        <i class="fas fa-check-circle fa-4x text-muted mb-3"></i>
                        <h4 class="text-muted">Không có lịch hẹn đã xác nhận</h4>
                    </div>
                </div>

                <!-- Tab Hoàn thành -->
                <div class="tab-pane fade" id="completed" role="tabpanel">
                    <div th:each="lichHen : ${lichHens}" th:if="${lichHen.trangThai == 'DA_HOAN_THANH'}" class="card service-card mb-4">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h5 th:text="${lichHen.dichVu?.tenDichVu} ?: 'Không xác định'">Dịch vụ</h5>
                                        <span class="badge-status badge-completed">
                                            <span th:text="${lichHen.trangThaiDisplayName}">Đã Hoàn Thành</span>
                                        </span>
                                    </div>
                                    <p class="mb-1">
                                        <i class="fas fa-user-md text-primary me-2"></i>
                                        <span th:text="${lichHen.bacSi?.hoTen} ?: 'Không xác định'">Bác sĩ</span>
                                    </p>
                                    <p class="mb-1">
                                        <i class="fas fa-clock text-primary me-2"></i>
                                        <span th:text="${#temporals.format(lichHen.thoiGianHen, 'dd/MM/yyyy HH:mm')}">Thời gian</span>
                                    </p>
                                    <p class="mb-0 text-muted" th:if="${lichHen.lyDoKham}">
                                        <i class="fas fa-sticky-note me-2"></i>
                                        <span th:text="${lichHen.lyDoKham}">Lý do khám</span>
                                    </p>
                                </div>
                                <div class="col-md-4 text-end">
                                    <a th:href="@{/lich-hen/{id}(id=${lichHen.id})}" class="btn btn-outline-primary btn-sm">
                                        <i class="fas fa-eye me-1"></i>Chi Tiết
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div th:if="${lichHenHoanThanh == 0}" class="text-center py-5">
                        <i class="fas fa-trophy fa-4x text-muted mb-3"></i>
                        <h4 class="text-muted">Không có lịch hẹn đã hoàn thành</h4>
                    </div>
                </div>

            </div>
        </div>
    </section>

    <footer th:replace="~{fragments/footer :: footer}"></footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
